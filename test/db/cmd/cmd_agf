NAME=agfj resolv reloc symbols
FILE=bins/elf/ls
CMDS=<<EOF
aa 2> /dev/null
aac 2> /dev/null
s 0x0000f190
agfj~free
EOF
EXPECT=<<EOF
[{"name":"fcn.0000d440","addr":54336,"ninstr":50,"nargs":0,"nlocals":1,"size":7527,"stack":80,"type":"fcn","blocks":[{"addr":54336,"size":5,"jump":54464,"fail":54341,"ops":[{"addr":54336,"esil":"0,rdi,rdi,&,==,$z,zf,:=,$p,pf,:=,63,$s,sf,:=,0,cf,:=,0,of,:=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"test rdi, rdi","disasm":"test rdi, rdi","bytes":"4885ff","family":"cpu","type":"acmp","reloc":false,"type_num":16,"type2_num":0,"flags":["fcn.0000d440"],"xrefs":[{"addr":52760,"type":"CALL","perm":"--x"}]},{"addr":54339,"esil":"zf,?{,54464,rip,=,}","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"je 0xd4c0","disasm":"je 0xd4c0","bytes":"747b","family":"cpu","type":"cjmp","reloc":false,"type_num":2147483649,"type2_num":0,"jump":54464,"fail":54341}]},{"addr":54464,"size":1,"ops":[{"addr":54464,"esil":"rsp,[8],rip,=,8,rsp,+=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"ret","disasm":"ret","bytes":"c3","family":"cpu","type":"ret","reloc":false,"type_num":5,"type2_num":0}]},{"addr":54341,"size":78,"jump":54465,"fail":54419,"ops":[{"addr":54341,"esil":"r13,8,rsp,-,=[8],8,rsp,-=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"push r13","disasm":"push r13","bytes":"4155","family":"cpu","type":"rpush","reloc":false,"type_num":268435468,"type2_num":0},{"addr":54343,"esil":"rdi,r13,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov r13, rdi","disasm":"mov r13, rdi","bytes":"4989fd","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54346,"ptr":24,"val":24,"esil":"24,rdi,=","refptr":0,"fcn_addr":54336,"fcn_last":61858,"size":5,"opcode":"mov edi, 0x18","disasm":"mov edi, 0x18","bytes":"bf18000000","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0,"refs":[{"addr":24,"type":"DATA","perm":"r--"}]},{"addr":54351,"esil":"r12,8,rsp,-,=[8],8,rsp,-=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"push r12","disasm":"push r12","bytes":"4154","family":"cpu","type":"rpush","reloc":false,"type_num":268435468,"type2_num":0},{"addr":54353,"esil":"rsi,r12,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov r12, rsi","disasm":"mov r12, rsi","bytes":"4989f4","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54356,"esil":"rbp,8,rsp,-,=[8],8,rsp,-=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"push rbp","disasm":"push rbp","bytes":"55","family":"cpu","type":"rpush","reloc":false,"type_num":268435468,"type2_num":0},{"addr":54357,"esil":"rdx,rbp,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rbp, rdx","disasm":"mov rbp, rdx","bytes":"4889d5","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54360,"esil":"rbx,8,rsp,-,=[8],8,rsp,-=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"push rbx","disasm":"push rbx","bytes":"53","family":"cpu","type":"rpush","reloc":false,"type_num":268435468,"type2_num":0},{"addr":54361,"val":8,"esil":"8,rsp,-=,8,0x8000000000000000,-,!,63,$o,^,of,:=,63,$s,sf,:=,$z,zf,:=,$p,pf,:=,64,$b,cf,:=,3,$b,af,:=","refptr":0,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"sub rsp, 8","disasm":"sub rsp, 8","bytes":"4883ec08","family":"cpu","type":"sub","reloc":false,"type_num":18,"type2_num":0},{"addr":54365,"esil":"84992,rip,8,rsp,-=,rsp,=[8],rip,=","refptr":0,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"call 0x14c00","disasm":"call fcn.00014c00","bytes":"67e89d770000","family":"cpu","type":"call","reloc":false,"type_num":3,"type2_num":0,"jump":84992,"fail":54371,"refs":[{"addr":84992,"type":"CALL","perm":"--x"}]},{"addr":54371,"esil":"r12,rdi,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rdi, r12","disasm":"mov rdi, r12","bytes":"4c89e7","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54374,"esil":"rax,rbx,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rbx, rax","disasm":"mov rbx, rax","bytes":"4889c3","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54377,"esil":"85568,rip,8,rsp,-=,rsp,=[8],rip,=","refptr":0,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"call 0x14e40","disasm":"call fcn.00014e40","bytes":"67e8d1790000","family":"cpu","type":"call","reloc":false,"type_num":3,"type2_num":0,"jump":85568,"fail":54383,"refs":[{"addr":85568,"type":"CALL","perm":"--x"}]},{"addr":54383,"esil":"rbx,rsi,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rsi, rbx","disasm":"mov rsi, rbx","bytes":"4889de","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54386,"esil":"r13,rdi,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rdi, r13","disasm":"mov rdi, r13","bytes":"4c89ef","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54389,"esil":"rax,rbx,=[8]","refptr":8,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov qword [rbx], rax","disasm":"mov qword [rbx], rax","bytes":"488903","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54392,"esil":"0x8,rbp,+,[8],rax,=","refptr":8,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"mov rax, qword [rbp + 8]","disasm":"mov rax, qword [rbp + 8]","bytes":"488b4508","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54396,"esil":"rax,0x8,rbx,+,=[8]","refptr":8,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"mov qword [rbx + 8], rax","disasm":"mov qword [rbx + 8], rax","bytes":"48894308","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54400,"esil":"rbp,[8],rax,=","refptr":8,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"mov rax, qword [rbp]","disasm":"mov rax, qword [rbp]","bytes":"488b4500","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54404,"esil":"rax,0x10,rbx,+,=[8]","refptr":8,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"mov qword [rbx + 0x10], rax","disasm":"mov qword [rbx + 0x10], rax","bytes":"48894310","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54408,"esil":"61056,rip,8,rsp,-=,rsp,=[8],rip,=","refptr":0,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"call 0xee80","disasm":"call fcn.0000ee80","bytes":"67e8f2190000","family":"cpu","type":"call","reloc":false,"type_num":3,"type2_num":0,"jump":61056,"fail":54414,"refs":[{"addr":61056,"type":"CALL","perm":"--x"}]},{"addr":54414,"esil":"0,rax,rax,&,==,$z,zf,:=,$p,pf,:=,63,$s,sf,:=,0,cf,:=,0,of,:=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"test rax, rax","disasm":"test rax, rax","bytes":"4885c0","family":"cpu","type":"acmp","reloc":false,"type_num":16,"type2_num":0},{"addr":54417,"esil":"zf,?{,54465,rip,=,}","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"je 0xd4c1","disasm":"je 0xd4c1","bytes":"742e","family":"cpu","type":"cjmp","reloc":false,"type_num":2147483649,"type2_num":0,"jump":54465,"fail":54419}]},{"addr":54465,"size":15,"jump":54480,"ops":[{"addr":54465,"esil":"85600,rip,8,rsp,-=,rsp,=[8],rip,=","refptr":0,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"call 0x14e60","disasm":"call fcn.00014e60","bytes":"67e899790000","family":"cpu","type":"call","reloc":false,"type_num":3,"type2_num":0,"jump":85600,"fail":54471,"refs":[{"addr":85600,"type":"CALL","perm":"--x"}]},{"addr":54471,"esil":",","refptr":0,"fcn_addr":54336,"fcn_last":61854,"size":9,"opcode":"nop word [rax + rax]","disasm":"nop word [rax + rax]","bytes":"660f1f840000000000","family":"cpu","type":"nop","reloc":false,"type_num":8,"type2_num":0}]},{"addr":54419,"size":5,"jump":54448,"fail":54424,"ops":[{"addr":54419,"esil":"rax,rbx,==,$z,zf,:=,64,$b,cf,:=,$p,pf,:=,63,$s,sf,:=,rax,0x8000000000000000,-,!,63,$o,^,of,:=,3,$b,af,:=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"cmp rbx, rax","disasm":"cmp rbx, rax","bytes":"4839c3","family":"cpu","type":"cmp","reloc":false,"type_num":15,"type2_num":0},{"addr":54422,"esil":"zf,?{,54448,rip,=,}","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"je 0xd4b0","disasm":"je 0xd4b0","bytes":"7418","family":"cpu","type":"cjmp","reloc":false,"type_num":2147483649,"type2_num":0,"jump":54448,"fail":54424}]},{"addr":54448,"size":11,"ops":[{"addr":54448,"val":8,"esil":"8,rsp,+=,63,$o,of,:=,63,$s,sf,:=,$z,zf,:=,63,$c,cf,:=,$p,pf,:=,3,$c,af,:=","refptr":0,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"add rsp, 8","disasm":"add rsp, 8","bytes":"4883c408","family":"cpu","type":"add","reloc":false,"type_num":17,"type2_num":0},{"addr":54452,"esil":"rsp,[8],8,rsp,+=,rbx,=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"pop rbx","disasm":"pop rbx","bytes":"5b","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54453,"esil":"rsp,[8],8,rsp,+=,rbp,=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"pop rbp","disasm":"pop rbp","bytes":"5d","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54454,"esil":"rsp,[8],8,rsp,+=,r12,=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"pop r12","disasm":"pop r12","bytes":"415c","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54456,"esil":"rsp,[8],8,rsp,+=,r13,=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"pop r13","disasm":"pop r13","bytes":"415d","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54458,"esil":"rsp,[8],rip,=,8,rsp,+=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"ret","disasm":"ret","bytes":"c3","family":"cpu","type":"ret","reloc":false,"type_num":5,"type2_num":0}]},{"addr":54424,"size":18,"jump":61840,"ops":[{"addr":54424,"val":8,"esil":"8,rsp,+=,63,$o,of,:=,63,$s,sf,:=,$z,zf,:=,63,$c,cf,:=,$p,pf,:=,3,$c,af,:=","refptr":0,"fcn_addr":54336,"fcn_last":61859,"size":4,"opcode":"add rsp, 8","disasm":"add rsp, 8","bytes":"4883c408","family":"cpu","type":"add","reloc":false,"type_num":17,"type2_num":0},{"addr":54428,"esil":"rbx,rdi,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rdi, rbx","disasm":"mov rdi, rbx","bytes":"4889df","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":54431,"esil":"rsp,[8],8,rsp,+=,rbx,=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"pop rbx","disasm":"pop rbx","bytes":"5b","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54432,"esil":"rsp,[8],8,rsp,+=,rbp,=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"pop rbp","disasm":"pop rbp","bytes":"5d","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54433,"esil":"rsp,[8],8,rsp,+=,r12,=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"pop r12","disasm":"pop r12","bytes":"415c","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54435,"esil":"rsp,[8],8,rsp,+=,r13,=","refptr":0,"fcn_addr":54336,"fcn_last":61861,"size":2,"opcode":"pop r13","disasm":"pop r13","bytes":"415d","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":54437,"esil":"0xf190,rip,=","refptr":0,"fcn_addr":54336,"fcn_last":61858,"size":5,"opcode":"jmp 0xf190","disasm":"jmp 0xf190","bytes":"e9e61c0000","family":"cpu","type":"jmp","reloc":false,"type_num":1,"type2_num":0,"jump":61840,"refs":[{"addr":61840,"type":"CODE","perm":"--x"}]}]},{"addr":61840,"size":23,"ops":[{"addr":61840,"esil":"rbx,8,rsp,-,=[8],8,rsp,-=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"push rbx","disasm":"push rbx","bytes":"53","family":"cpu","type":"rpush","reloc":false,"type_num":268435468,"type2_num":0,"xrefs":[{"addr":53124,"type":"DATA","perm":"r--"},{"addr":54437,"type":"CODE","perm":"--x"}]},{"addr":61841,"esil":"rdi,rbx,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rbx, rdi","disasm":"mov rbx, rdi","bytes":"4889fb","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":61844,"esil":"rdi,[8],rdi,=","refptr":8,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rdi, qword [rdi]","disasm":"mov rdi, qword [rdi]","bytes":"488b3f","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":61847,"ptr":138400,"esil":"0x12b03,rip,+,[8],rip,8,rsp,-=,rsp,=[8],rip,=","refptr":8,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"call qword [rip + 0x12b03]","disasm":"call qword [reloc.free]","bytes":"ff15032b0100","family":"cpu","type":"ircall","reloc":false,"type_num":402653188,"type2_num":0,"refs":[{"addr":138400,"type":"CALL","perm":"--x"}]},{"addr":61853,"esil":"rbx,rdi,=","refptr":0,"fcn_addr":54336,"fcn_last":61860,"size":3,"opcode":"mov rdi, rbx","disasm":"mov rdi, rbx","bytes":"4889df","family":"cpu","type":"mov","reloc":false,"type_num":9,"type2_num":0},{"addr":61856,"esil":"rsp,[8],8,rsp,+=,rbx,=","refptr":0,"fcn_addr":54336,"fcn_last":61862,"size":1,"opcode":"pop rbx","disasm":"pop rbx","bytes":"5b","family":"cpu","type":"pop","reloc":false,"type_num":14,"type2_num":0},{"addr":61857,"ptr":138400,"esil":"0x12af9,rip,+,[8],rip,=","refptr":8,"fcn_addr":54336,"fcn_last":61857,"size":6,"opcode":"jmp qword [rip + 0x12af9]","disasm":"jmp qword [reloc.free]","bytes":"ff25f92a0100","family":"cpu","type":"irjmp","reloc":false,"type_num":402653186,"type2_num":0,"refs":[{"addr":138400,"type":"DATA","perm":"--x"}]}]}]}]
EOF
RUN

NAME=agfJ
FILE=-
CMDS=<<EOF
e asm.arch=x86
e asm.bits=64
s 0x42
wx 00004883f80074060000000000000000c3
af
agfJ
EOF
EXPECT=<<EOF
[{"name":"fcn.00000042","addr":66,"ninstr":8,"nargs":0,"nlocals":0,"size":17,"stack":0,"type":"fcn","blocks":[{"addr":66,"size":8,"jump":80,"fail":74,"ops":[{"addr":66,"text":"17: fcn.00000042 ();"},{"addr":66,"text":"     0000           add byte [rax], al"},{"addr":68,"text":"     4883f800       cmp rax, 0"},{"addr":72,"arrow":80,"text":"     7406           je 0x50"}]},{"addr":80,"size":3,"ops":[{"addr":80,"text":"     0000           add byte [rax], al"},{"addr":82,"text":"     c3             ret"}]},{"addr":74,"size":6,"jump":80,"ops":[{"addr":74,"text":"     0000           add byte [rax], al"},{"addr":76,"text":"     0000           add byte [rax], al"},{"addr":78,"text":"     0000           add byte [rax], al"}]}]}]
EOF
RUN

NAME=agfdm correct jump tables
FILE=-
CMDS=<<EOF
e asm.arch=x86
e asm.bits=64
s 0x100
wx 42000000000000004e000000000000005a00000000000000660000000000000072000000000000007e00000000000000
s 0x10
wx 554889e5897dfcc745f8000000008b45fc89c14889ca4883ea0548894df00f8756000000488b45f0488b0cc500010000ffe1c745f800000000e943000000c745f801000000e937000000c745f802000000e92b000000c745f803000000e91f000000c745f804000000e913000000c745f805000000e907000000c745f8ffffffff8b45f85dc3
af
agfdm
EOF
EXPECT=<<EOF
digraph code {
	graph [fontsize=8 fontname="Courier" bgcolor=azure splines="ortho"];
	node [fillcolor=white style=filled shape=box];
	edge [arrowhead="normal"];
	"0x00000010" [URL="fcn.00000010/0x00000010", fontcolor="#767676", fontname="Courier"]
	"0x0000008a" [URL="fcn.00000010/0x0000008a", fontcolor="#767676", fontname="Courier"]
	"0x00000034" [URL="fcn.00000010/0x00000034", fontcolor="#767676", fontname="Courier"]
	"0x00000042" [URL="fcn.00000010/0x00000042", fontcolor="#767676", fontname="Courier"]
	"0x00000091" [URL="fcn.00000010/0x00000091", fontcolor="#767676", fontname="Courier"]
	"0x0000004e" [URL="fcn.00000010/0x0000004e", fontcolor="#767676", fontname="Courier"]
	"0x0000005a" [URL="fcn.00000010/0x0000005a", fontcolor="#767676", fontname="Courier"]
	"0x00000066" [URL="fcn.00000010/0x00000066", fontcolor="#767676", fontname="Courier"]
	"0x00000072" [URL="fcn.00000010/0x00000072", fontcolor="#767676", fontname="Courier"]
	"0x0000007e" [URL="fcn.00000010/0x0000007e", fontcolor="#767676", fontname="Courier"]
        "0x00000010" -> "0x0000008a" [color="#13a10e"];
        "0x00000010" -> "0x00000034" [color="#c50f1f"];
        "0x0000008a" -> "0x00000091" [color="#3a96dd"];
        "0x00000034" -> "0x00000042" [color="#3a96dd"];
        "0x00000034" -> "0x0000004e" [color="#3a96dd"];
        "0x00000034" -> "0x0000005a" [color="#3a96dd"];
        "0x00000034" -> "0x00000066" [color="#3a96dd"];
        "0x00000034" -> "0x00000072" [color="#3a96dd"];
        "0x00000034" -> "0x0000007e" [color="#3a96dd"];
        "0x00000042" -> "0x00000091" [color="#3a96dd"];
        "0x0000004e" -> "0x00000091" [color="#3a96dd"];
        "0x0000005a" -> "0x00000091" [color="#3a96dd"];
        "0x00000066" -> "0x00000091" [color="#3a96dd"];
        "0x00000072" -> "0x00000091" [color="#3a96dd"];
        "0x0000007e" -> "0x00000091" [color="#3a96dd"];
}
EOF
RUN

NAME=agfm basic mermaid output
FILE=bins/elf/ls
CMDS=<<EOF
s sym._obstack_newchunk
af
agfm
EOF
EXPECT=<<EOF
stateDiagram-v2
  state "[0x15cc0] sym._obstack_newchunk" as _0x15cc0
  state "[0x15d06]" as _0x15d06
  state "[0x15d12]" as _0x15d12
  state "[0x15d29]" as _0x15d29
  state "[0x15d67]" as _0x15d67
  state "[0x15d7e]" as _0x15d7e
  state "[0x15da0]" as _0x15da0
  state "[0x15db5]" as _0x15db5
  _0x15cc0 --> _0x15db5: true
  _0x15cc0 --> _0x15d06: false
  _0x15d06 --> _0x15db5: true
  _0x15d06 --> _0x15d12: false
  _0x15d12 --> _0x15db5: true
  _0x15d12 --> _0x15d29: false
  _0x15d29 --> _0x15d7e: true
  _0x15d29 --> _0x15d67: false
  _0x15d67 --> _0x15da0: true
  _0x15d67 --> _0x15d7e: false
  _0x15da0 --> _0x15d7e
EOF
RUN

NAME=agfma basic mermaid output
FILE=bins/elf/ls
CMDS=<<EOF
s sym._obstack_newchunk
af
agfma
EOF
EXPECT=<<EOF
stateDiagram-v2
  state "[0x15cc0] sym._obstack_newchunk\npush r14\nxor eax, eax\npush r13\npush r12\npush rbp\npush rbx\nmov r13, qword [rdi + 0x18]\nsub r13, qword [rdi + 0x10]\nmov rbp, qword [rdi + 8]\nadd rsi, r13\nmov rdx, r13\nsetb al\nadd rsi, qword [rdi + 0x30]\nsetb cl\nshr rdx, 3\ncmp qword [rdi], rsi\nlea rbx, [rsi + rdx + 0x64]\ncmovae rsi, qword [rdi]\ncmp rsi, rbx\ncmovae rbx, rsi\ntest rax, rax\njne 0x15db5\n" as _0x15cc0
  state "[0x15d06]\nmovzx ecx, cl\ntest rcx, rcx\njne 0x15db5\n" as _0x15d06
  state "[0x15d12]\nmov rsi, rbx\nmov r12, rdi\ncall 0x15bb0\nmov r14, rax\ntest rax, rax\nje 0x15db5\n" as _0x15d12
  state "[0x15d29]\nlea rsi, [rax + rbx]\nmov qword [r12 + 8], rax\nmov rdx, r13\nmov qword [rax + 8], rbp\nmov qword [r12 + 0x20], rsi\nmov qword [rax], rsi\nmov rax, qword [r12 + 0x30]\nmov rsi, qword [r12 + 0x10]\nlea rbx, [r14 + rax + 0x10]\nnot rax\nand rbx, rax\nmov rdi, rbx\ncall qword [rip + 0xc119]\ntest byte [r12 + 0x50], 2\njne 0x15d7e\n" as _0x15d29
  state "[0x15d67]\nmov rax, qword [r12 + 0x30]\nlea rdx, [rbp + rax + 0x10]\nnot rax\nand rax, rdx\ncmp qword [r12 + 0x10], rax\nje 0x15da0\n" as _0x15d67
  state "[0x15d7e]\nadd r13, rbx\nmov qword [r12 + 0x10], rbx\nmov qword [r12 + 0x18], r13\nand byte [r12 + 0x50], 0xfd\npop rbx\npop rbp\npop r12\npop r13\npop r14\nret\n" as _0x15d7e
  state "[0x15da0]\nmov rax, qword [rbp + 8]\nmov rsi, rbp\nmov rdi, r12\nmov qword [r14 + 8], rax\ncall 0x15bd0\njmp 0x15d7e\n" as _0x15da0
  state "[0x15db5]\ncall qword [rip + 0xc4a5]\nnop dword [rax + rax]\n" as _0x15db5
  _0x15cc0 --> _0x15db5: true
  _0x15cc0 --> _0x15d06: false
  _0x15d06 --> _0x15db5: true
  _0x15d06 --> _0x15d12: false
  _0x15d12 --> _0x15db5: true
  _0x15d12 --> _0x15d29: false
  _0x15d29 --> _0x15d7e: true
  _0x15d29 --> _0x15d67: false
  _0x15d67 --> _0x15da0: true
  _0x15d67 --> _0x15d7e: false
  _0x15da0 --> _0x15d7e
EOF
RUN

NAME=agfm on jump table
CMDS=<<EOF
e asm.arch=x86
e asm.bits=64
s 0x100
wx 42000000000000004e000000000000005a00000000000000660000000000000072000000000000007e00000000000000
s 0x10
wx 554889e5897dfcc745f8000000008b45fc89c14889ca4883ea0548894df00f8756000000488b45f0488b0cc500010000ffe1c745f800000000e943000000c745f801000000e937000000c745f802000000e92b000000c745f803000000e91f000000c745f804000000e913000000c745f805000000e907000000c745f8ffffffff8b45f85dc3
af
agfm
EOF
EXPECT=<<EOF
stateDiagram-v2
  state "[0x10] fcn.00000010" as _0x10
  state "[0x34]" as _0x34
  state "[0x42]" as _0x42
  state "[0x4e]" as _0x4e
  state "[0x5a]" as _0x5a
  state "[0x66]" as _0x66
  state "[0x72]" as _0x72
  state "[0x7e]" as _0x7e
  state "[0x8a]" as _0x8a
  state "[0x91]" as _0x91
  _0x10 --> _0x8a: true
  _0x10 --> _0x34: false
  _0x34 --> _0x42: Case 0
  _0x34 --> _0x4e: Case 1
  _0x34 --> _0x5a: Case 2
  _0x34 --> _0x66: Case 3
  _0x34 --> _0x72: Case 4
  _0x34 --> _0x7e: Case 5
  _0x42 --> _0x91
  _0x4e --> _0x91
  _0x5a --> _0x91
  _0x66 --> _0x91
  _0x72 --> _0x91
  _0x7e --> _0x91
  _0x8a --> _0x91
EOF
RUN
