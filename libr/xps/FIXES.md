# XPS Build System Fixes

This document summarizes the fixes implemented to make the Meson build system work properly for external plugins.

## Issues Fixed

### 0. Clarification: p/meson.build is Auto-Generated

**Initial Misunderstanding**: p/meson.build should NOT be manually maintained.

**Correct Behavior**: 
- The Makefile automatically generates this file when you run `make -C libr/xps`
- It reads `config.mk` to find `EXTERNAL_PLUGINS`
- It scans each plugin's `static.cfg` 
- It generates the appropriate `subdir()` calls

**Action Taken**: Removed the manually created p/meson.build file (it was overwriting the auto-generated one).

**How Meson Works Now**:
1. User runs `make -C libr/xps` 
2. Makefile generates `p/meson.build` with proper plugin enumeration
3. Meson reads the generated file and includes all plugins
4. This is the correct workflow - both Make and Meson use the same auto-generated files

### 1. Variable Initialization Order ✓ FIXED

**Problem**: `r_core_additional_sources` and `r_core_additional_inc` variables were not initialized before external plugins tried to append to them.

**Fix**: Modified `libr/xps/meson.build` to explicitly initialize these variables before processing external plugins:

```meson
# Initialize external plugin variables (these may be used by external plugins)
# Must be done before subdirectory processing
if not is_variable('r_core_additional_sources')
  r_core_additional_sources = []
endif
if not is_variable('r_core_additional_inc')
  r_core_additional_inc = []
endif
```

This ensures that when `subdir('p')` is called, the plugin meson.build files can safely append to these variables.

### 2. Hardcoded Paths in Plugin meson.build ✓ FIXED

**Problem**: The r2hermes plugin's meson.build used hardcoded absolute paths that broke path resolution in Meson.

**Original Code**:
```meson
r_core_additional_inc += ['../xps/p/r2hermes/include']
```

**Fixed Code**:
```meson
include_dirs = include_directories('../include', is_system: false)
r_core_additional_inc += include_dirs
```

All paths are now relative to the meson.build file location, which is the proper way to handle paths in Meson.

### 3. Meson configure_file() Configuration ✓ FIXED

**Problem**: Used both `configuration` and `copy` keywords which are mutually exclusive in Meson.

**Fix**: Removed the `copy` keyword and kept only `configuration`:

```meson
deps_h = configure_file(
  input: 'r2plugins.h.in',
  output: 'r2plugins.h',
  configuration: configuration_data()
)
```

## Verification

The fixes have been verified by:

1. **Meson setup succeeds**: `meson setup builddir` completes without errors
2. **Plugin sources are compiled**: r2hermes source files appear in compile_commands.json
3. **Includes are propagated**: `-I../libr/xps/p/r2hermes/include` appears in all r_core compilation commands

Sample from compile_commands.json:
```json
{
  "file": "../libr/xps/p/r2hermes/src/lib/utils/string_buffer.c",
  "command": "cc ... -I../libr/xps/p/r2hermes/include ... -c ../libr/xps/p/r2hermes/src/lib/utils/string_buffer.c"
}
```

## Files Changed

1. **libr/xps/README.md** - Comprehensive documentation (new file) - UPDATED
2. **libr/xps/BUGS.md** - Identified issues and proposed improvements (new file) - UPDATED
3. **libr/xps/meson.build** - Fixed variable initialization and r2plugins.h generation
4. **libr/xps/p/r2hermes/r2plugin/meson.build** - Fixed path handling to use proper relative paths

**Note**: p/meson.build is auto-generated by the Makefile and should NEVER be manually edited. It's created when you run `make -C libr/xps`.

## Remaining Work

### High Priority

1. **Automatic Plugin Discovery**: Instead of manually listing plugins in `libr/xps/p/meson.build`, implement automatic directory scanning
2. **Make Build Fix**: Verify that the Make build system still works correctly with external plugins
3. **Plugin Type Support**: Ensure all plugin types (core, asm, arch, bin, etc.) are properly handled in both build systems

### Medium Priority

1. **r2plugins.h Generation for Meson**: The Make system auto-generates `r2plugins.h` with extern declarations, but Meson doesn't need this since it directly includes source files
2. **Unified Plugin Manifest**: Create a standardized format for plugin definitions consumable by both Make and Meson
3. **Testing**: Add test cases for external plugin compilation

### Low Priority

1. **Documentation Updates**: Update main README.md to mention XPS system
2. **Configuration UX**: Improve the workflow for enabling external plugins

## Build System Behavior After Fixes

### Make System

```bash
# Still works as before
make -C libr/xps/p/r2hermes include/hbc/version.h
make -C libr/xps/p/r2hermes
make -C libr/xps
make -j
```

### Meson System

```bash
# Now works correctly
meson setup builddir
meson compile -C builddir
# r2hermes sources are automatically compiled as part of r_core
```

Both systems now properly integrate external plugin sources into the main build.

