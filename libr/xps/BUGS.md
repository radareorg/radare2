# XPS (eXternal PluginS) - Known Issues and Limitations

## Critical Issues

### 1. Meson Build Doesn't Load External Plugin Sources

**Severity**: CRITICAL

**Issue**: The Meson build system does not automatically include external plugin source files or include directories into `r_core`. While the Make system works, the Meson integration is broken.

**Root Cause**: 
- In `libr/meson.build`, the `subdir('xps')` is called but the generated `r_core_additional_sources` and `r_core_additional_inc` variables are NOT properly initialized before external plugins try to append to them.
- Specifically, line 592-593 in `libr/meson.build` declares `r_core_additional_inc = []` and then immediately does `subdir('xps')`, but there's a timing issue where the xps subdir meson.build doesn't execute until later.
- The external plugin's `meson.build` files (e.g., `libr/xps/p/r2hermes/r2plugin/meson.build`) try to append to these variables, but they may not be properly propagated to `libr/core/meson.build`.

**Observed Behavior**:
- Building with Meson: external plugin sources are never compiled or linked
- Building with Make: works correctly when `make -C libr/xps` is run first

**Solution**:
- Ensure `r_core_additional_sources = []` and `r_core_additional_inc = []` are declared in `libr/meson.build` BEFORE `subdir('xps')`
- The `subdir('xps')` needs to recursively process all plugin `meson.build` files
- The `libr/xps/p/meson.build` must enumerate all plugin directories and call `subdir()` on their `r2plugin` subdirectories
- Alternative: use Meson's `dependency()` declarations for cleaner integration

### 2. libr/xps/p/meson.build is Empty (EXPECTED BEHAVIOR)

**Severity**: CLARIFICATION (not a bug)

**Issue**: The file `libr/xps/p/meson.build` is empty in the git repository.

**Root Cause**: This file is **auto-generated** by the Makefile when you run `make -C libr/xps`.

**Expected Behavior**: 
- File is empty in git (don't commit it)
- When you run `make -C libr/xps`, it's automatically generated to enumerate all plugins:

```meson
# libr/xps/p/meson.build (generated by Makefile)
subdir('r2hermes/r2plugin')
subdir('hi/r2plugin')
# ... etc
```

**Solution**: 
- Do NOT manually edit this file
- Always run `make -C libr/xps` after updating `config.mk` to regenerate it
- Add to .gitignore if not already there

### 3. Hardcoded Paths in External Plugin meson.build

**Severity**: MEDIUM

**Issue**: Plugin `meson.build` files use hardcoded relative paths that break when building in different contexts.

**Example** (from `libr/xps/p/r2hermes/r2plugin/meson.build`):
```meson
configure_file(
  input: '../include/hbc/version.h.in',  # Assumes specific relative path
  ...
)
r_core_additional_inc += ['../xps/p/r2hermes/include']  # Hardcoded path
```

**Problems**:
- Path `'../xps/p/r2hermes/include'` is incorrect in Meson context (should be relative to where meson.build is)
- When building from different directories, paths break
- Meson expects paths relative to the current `meson.build` location

**Solution**: Use Meson's `meson.current_source_dir()` and `meson.current_build_dir()` for dynamic path resolution, or use relative paths from the subdir location.

### 4. Duplicate Plugin Definition Formats

**Severity**: MEDIUM

**Issue**: External plugins may define both core plugins AND other types (asm, arch, bin) but the XPS system doesn't handle them consistently between Make and Meson.

**Example**:
- `static.cfg` lists: `core.r2hermes asm.r2hermes arch.r2hermes bin.r2hermes`
- But Make build expects separate `.mk` files for each
- Meson build has no infrastructure for this multi-type model

**Problem**: An external plugin wanting to provide multiple plugin types must:
- For Make: create `r2plugin/core/deps.mk`, `r2plugin/asm/deps.mk`, `r2plugin/arch/deps.mk`, etc.
- For Meson: create separate `shared_library()` targets in different `meson.build` files
- The coordination is manual and error-prone

**Solution**: Create a unified plugin definition format that both build systems can consume. See "Build System Improvements" section.

### 5. No Dependency Management Between Plugin Types

**Severity**: MEDIUM

**Issue**: If a plugin provides both core + asm components, there's no way to express that asm depends on core's static library.

**Current Workaround**: Each plugin type independently links against the external library (e.g., `libhbc.a`), causing duplication.

**Solution**: Define plugin dependencies in a manifest file (e.g., `PLUGIN.manifest` or structured `static.cfg`).

### 6. Generated r2plugins.h is Incomplete

**Severity**: LOW

**Issue**: The `r2plugins.h` file generated by Make only includes extern declarations for core plugins, not for other types.

**Reason**: The Makefile only processes `core/deps.h` files by default.

**Impact**: Other plugin types don't get their extern declarations auto-injected.

**Solution**: Update `libr/xps/Makefile` to process all plugin type directories:
```makefile
r2plugins.h:
	:> r2plugins.h
	for a in $(EXTERNAL_PLUGINS) ; do \
		for type in core asm arch bin ; do \
			if [ -f "p/$$a/r2plugin/$$type/deps.h" ]; then \
				cat "p/$$a/r2plugin/$$type/deps.h" >> r2plugins.h ; \
			fi ; \
		done ; \
	done
```

## Design Issues

### 7. XPS System is "Hidden" and Poorly Discovered

**Severity**: LOW

**Issue**: Users don't know XPS exists or how to use it:
- No mention in main README.md
- No mention in CONTRIBUTING.md or DEVELOPERS.md
- The system is undocumented in the main repository

**Solution**: Add links from main documentation to `libr/xps/README.md`.

### 8. config.mk Pattern is Awkward

**Severity**: LOW

**Issue**: The workflow requires:
1. Copy `config.mk.example` to `config.mk`
2. Edit `config.mk`
3. Run `make -C libr/xps`
4. Run full `make` build

This is unintuitive and error-prone. Users might forget step 3.

**Solution**: 
- Option A: Auto-generate and include config based on `static.cfg`
- Option B: Add a bootstrap target: `make -C . install-xps-plugins`
- Option C: Allow `EXTERNAL_PLUGINS=r2hermes make` on command line without config.mk

### 9. No Validation of Plugin Definitions

**Severity**: LOW

**Issue**: If someone forgets to add a plugin to `EXTERNAL_PLUGINS` in config.mk, or provides an invalid `static.cfg`, the build silently ignores it.

**Solution**: Add validation in XPS Makefile/meson.build to warn about orphaned plugin directories.

## Architectural Improvements Needed

### 10. Unified Plugin Manifest Format

**Current State**:
- `static.cfg`: Simple text file listing `<type>.<name>` pairs
- `config.mk`: Shell makefile with manual plugin enumeration
- `meson.build` files: Ad-hoc source file listing

**Proposed Solution**: Unified plugin manifest:

```ini
# libr/xps/p/r2hermes/r2plugin/PLUGIN.manifest
[plugin]
name = r2hermes
version = 1.0.0
radare2_min_version = 6.0.0

[types]
core = true
asm = true
arch = true
bin = true

[sources]
shared = [ "../../src/lib" ]
core = [ "../../src/r2/core_hbc.c" ]
asm = [ "../../src/r2/asm_hbc.c" ]
arch = [ "../../src/r2/arch_hbc.c" ]
bin = [ "../../src/r2/bin_hbc.c" ]

[includes]
public = [ "../../include" ]

[dependencies]
static_libs = [ "../../build/libhbc.a" ]
```

This allows both Make and Meson to consume a single definition.

### 11. Automatic Plugin Discovery

**Current State**: Must manually enumerate plugins in `config.mk`

**Proposed Solution**: Scan `libr/xps/p/` directory for plugin directories and automatically include them if they have valid `PLUGIN.manifest` or `static.cfg`.

### 12. Meson Plugin Build System Redesign

**Current State**: Each plugin type has its own `meson.build` that manually appends sources to global variables.

**Better Approach**:
```meson
# libr/xps/meson.build (parent)
fs = import('fs')

r_core_additional_sources = []
r_core_additional_inc = []

plugin_dirs = fs.listdir('p')
foreach plugin : plugin_dirs
  if fs.is_dir('p' / plugin / 'r2plugin')
    subdir('p' / plugin / 'r2plugin')
  endif
endforeach
```

This would auto-discover plugins without empty `meson.build` files in `p/`.

## Make-Specific Issues

### 13. deps.mk References Non-Existent LIBR Variable

**Severity**: MEDIUM

**Issue**: In `libr/xps/p/r2hermes/r2plugin/core/deps.mk`:
```makefile
HBC_CORE_WD=$(LIBR)/xps/p/r2hermes
```

The `$(LIBR)` variable is defined in `libr/config.mk` but may not always be available when deps.mk is included, depending on include order.

**Solution**: Use absolute paths or ensure LIBR is defined early, or use a relative path calculation.

## Testing Issues

### 14. No XPS-Specific Tests

**Severity**: LOW

**Issue**: The XPS system has no dedicated test suite to verify:
- Plugin compilation with Make
- Plugin compilation with Meson
- Plugin type auto-discovery
- Plugin registration
- Multiple plugin types in one plugin

**Solution**: Add test targets in `libr/xps/` or test cases in `test/db/`.

## Summary of Fixes Required

### High Priority (Blocking)
1. **Fix Meson integration**: Make `libr/xps/p/meson.build` auto-generate or manually enumerate plugins
2. **Fix variable initialization order**: Ensure `r_core_additional_*` variables are ready before `subdir('xps')`
3. **Fix hardcoded paths in plugin meson.build files**: Use dynamic path resolution

### Medium Priority
4. Fix `r2plugins.h` generation to include all plugin types
5. Implement automatic plugin discovery
6. Create unified plugin manifest format
7. Improve Make paths to use $(LIBR) consistently

### Low Priority
8. Document the system (already done in README.md update)
9. Add validation and warnings
10. Create test suite
11. Improve UX of config.mk workflow

## Testing the Fixes

After implementing fixes, verify with:

```bash
# Make build test
make -C libr/xps
make clean
make -j
r2 -c 'Lc~hbc' /tmp/test.hbc

# Meson build test
rm -rf builddir
meson setup builddir
meson compile -C builddir
./builddir/binr/r2 -c 'Lc~hbc' /tmp/test.hbc
```

Both should show the hbc core plugin loaded.

