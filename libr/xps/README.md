# eXternal PluginS (XPS)

This directory handles the machinery to make third-party repositories build and link statically
as if they were part of radare2. The system works with both Make and Meson build systems.

## Important: Auto-Generated Files

The following files are **automatically generated by `make -C libr/xps`** and should **NEVER** be manually edited:
- `p/meson.build` - Generated from EXTERNAL_PLUGINS and plugin static.cfg files
- `static.cfg` - Aggregated from p/*/r2plugin/static.cfg files
- `deps.mk` - Aggregated from p/*/r2plugin/*/deps.mk files
- `r2plugins.h` - Generated from p/*/r2plugin/*/deps.h files

If you manually edit these files, they will be **overwritten** the next time you run `make -C libr/xps`.

## Architecture

The XPS system is a plugin integration framework that allows external radare2 plugins to be:
- Compiled as part of the main radare2 build
- Statically linked into the core library
- Expose any type of plugin (core, arch, asm, bin, etc.)

### Build Flow

```
1. User edits config.mk and adds plugin to EXTERNAL_PLUGINS
2. User creates p/<plugin>/r2plugin/ structure with:
   - static.cfg (declares plugin types)
   - <type>/deps.mk (Make build dependencies)
   - <type>/deps.h (extern declarations for plugin registration)
   - <type>/meson.build (Meson source integration)
3. User runs: make -C libr/xps
   - Generates: p/meson.build (from static.cfg files)
   - Generates: static.cfg (aggregated)
   - Generates: deps.mk (aggregated)
   - Generates: r2plugins.h (from deps.h files)
4. User builds radare2:
   - Make: ./configure && make -j
   - Meson: meson setup builddir && meson compile -C builddir
```

### Directory Structure

```
libr/xps/
├── p/                              # External plugin directories
│   ├── r2hermes/                   # Example: r2hermes external plugin
│   │   └── r2plugin/               # User-created plugin integration
│   │       ├── static.cfg          # USER FILE: Plugin type definitions
│   │       ├── meson.build         # USER FILE: Meson integration
│   │       ├── core/               # Core plugin type (optional)
│   │       │   ├── deps.h          # USER FILE: extern declarations
│   │       │   ├── deps.mk         # USER FILE: Make dependencies
│   │       │   └── meson.build     # USER FILE: Meson config
│   │       ├── asm/                # Assembler plugin type (optional)
│   │       │   ├── deps.h
│   │       │   ├── deps.mk
│   │       │   └── meson.build
│   │       └── ... other types ...
│   ├── hi/                         # Other external plugins (same structure)
│   ├── meson.build                 # AUTO-GENERATED: DO NOT EDIT
│   └── (other auto-generated files)
├── Makefile                        # Make build generator (read-only)
├── meson.build                     # Meson build generator (modified for Meson)
├── config.mk                       # USER FILE: EXTERNAL_PLUGINS list
├── config.mk.example               # Example configuration
├── static.cfg                      # AUTO-GENERATED: DO NOT EDIT
├── static.cfg.example              # Example output reference
├── deps.mk                         # AUTO-GENERATED: DO NOT EDIT
├── deps.h                          # AUTO-GENERATED: DO NOT EDIT
├── r2plugins.h                     # AUTO-GENERATED: DO NOT EDIT
├── r2plugins.h.in                  # Template (mostly unused)
└── README.md                       # This file
```

## How to Install r2hermes

### Prerequisites

- radare2 source code cloned locally
- git (for cloning r2hermes)
- standard build tools (gcc/clang, make/meson, ninja)
- For standalone r2hermes: `pkg-config r_core`

### Method 1: Compile as Part of radare2 (Recommended)

This integrates r2hermes plugins directly into the radare2 build.

#### Setup

1. Clone r2hermes into the xps plugins directory:

```bash
cd radare2
git clone https://github.com/radareorg/r2hermes libr/xps/p/r2hermes
cd libr/xps/p/r2hermes
git checkout r2p  # or the appropriate branch
```

2. Enable the plugin in xps configuration:

```bash
cp libr/xps/config.mk.example libr/xps/config.mk
# Edit libr/xps/config.mk to include:
# EXTERNAL_PLUGINS+=r2hermes
```

#### Using Make Build System

```bash
# Build r2hermes library prerequisites
make -C libr/xps/p/r2hermes include/hbc/version.h
make -C libr/xps/p/r2hermes

# Generate plugin integration files
make -C libr/xps

# Build radare2 with the plugin
./configure
make -j
sudo make install
```

#### Using Meson Build System

```bash
# Build r2hermes library prerequisites
make -C libr/xps/p/r2hermes include/hbc/version.h
make -C libr/xps/p/r2hermes

# Setup and compile radare2 with meson
meson setup builddir
meson compile -C builddir
sudo meson install -C builddir
```

### Method 2: Standalone r2hermes Build

Build r2hermes as a dynamic plugin for an already-installed radare2:

```bash
cd r2hermes
meson setup builddir --prefix=~/.local
meson compile -C builddir
meson install -C builddir
```

Then use it with radare2:

```bash
r2 -e plugins.load=core_hbc /path/to/hermes_bytecode_file
```

## Configuration

### Make Configuration (libr/xps/config.mk)

The `config.mk` file specifies which external plugins to include:

```makefile
# Enable r2hermes plugin
EXTERNAL_PLUGINS+=r2hermes

# Add targets to clone the plugin if not present
.PHONY: r2hermes
r2hermes: p/r2hermes

p/r2hermes:
	cd p && git clone https://github.com/radareorg/r2hermes
	cd p/r2hermes && git checkout r2p
```

### Plugin Definition (static.cfg)

Each external plugin must define `static.cfg` containing plugin types to build:

```
core.r2hermes
asm.r2hermes
arch.r2hermes
bin.r2hermes
```

Format: `<plugin_type>.<plugin_name>`

Valid plugin types: `core`, `asm`, `arch`, `bin`, `anal`, `debug`, etc.

### Integration Files

The XPS Makefile generates three files automatically:

1. **r2plugins.h** - Include guards for all external plugin dependencies
   - Generated from `r2plugin/*/deps.h` files
   - Included by `libr/core/cplugin.c`

2. **deps.mk** - Makefile dependencies for external plugins
   - Aggregates `r2plugin/*/deps.mk` files
   - Pulled into the core build

3. **static.cfg** - Aggregated plugin definitions
   - Lists all plugins to be compiled statically

## Build System Integration

### Make Integration

The XPS system integrates with Make through:

1. **libr/config.mk**: Includes `-I../xps` in CFLAGS
2. **libr/core/Makefile**: Includes `${STATIC_CORE_PLUGINS}` and external objects
3. **libr/core/cplugin.c**: Includes `#include "../xps/r2plugins.h"`

Plugin hooks are registered via `deps.h` declarations.

### Meson Integration

The XPS system integrates with Meson through:

1. **libr/meson.build**: Declares `r_core_additional_sources` and `r_core_additional_inc`
2. **libr/xps/meson.build**: Includes plugin subdirectories
3. **libr/xps/p/meson.build**: Lists all plugin subdirectories
4. **libr/xps/p/<plugin>/r2plugin/meson.build**: Appends to `r_core_additional_*`
5. **libr/core/meson.build**: Uses `r_core_additional_*` variables

## Creating Your Own External Plugin

### Required Files

Each external plugin at `libr/xps/p/your_plugin/` MUST provide:

```
your_plugin/
└── r2plugin/
    ├── static.cfg              (REQUIRED)
    ├── meson.build             (REQUIRED)
    ├── core/                   (if providing core plugin)
    │   ├── deps.h              (REQUIRED)
    │   ├── deps.mk             (REQUIRED)
    │   └── meson.build         (REQUIRED)
    ├── asm/                    (if providing asm plugin)
    │   ├── deps.h
    │   ├── deps.mk
    │   └── meson.build
    └── ... other types ...
```

### Step 1: Create static.cfg

This file declares which plugin types your plugin provides. The Make system uses this to aggregate plugin types.

```
core.your_plugin
asm.your_plugin
arch.your_plugin
```

**Format**: `<type>.<plugin_name>` where type is:
- `core`, `asm`, `arch`, `bin`, `anal`, `debug`, `lang`, `esil`, `bp`, `bp_hw`, `egg`, `fs`, `io`, `search`, `syscall`, `format`, etc.

### Step 2: Create r2plugin/meson.build

This file integrates your plugin's sources into the Meson build. It appends sources and includes to the core library.

```meson
# r2plugin/meson.build

# Ensure variables exist (they're initialized by libr/xps/meson.build)
if not is_variable('r_core_additional_inc')
  r_core_additional_inc = []
endif
if not is_variable('r_core_additional_sources')
  r_core_additional_sources = []
endif

# Add your plugin's include directories
include_dirs = include_directories('../include', is_system: false)
r_core_additional_inc += include_dirs

# Add your plugin's source files to core
plugin_sources = files(
  '../src/your_plugin.c',
  '../src/your_plugin_util.c',
  # ... more source files ...
)
r_core_additional_sources += plugin_sources
```

**Important**: Paths are relative to the r2plugin/ directory where this meson.build file is located.

### Step 3: For Each Plugin Type, Create Type-Specific Files

For each type you declared in `static.cfg`, create a subdirectory with these files:

#### `<type>/deps.h`

C header file that declares your plugin's extern symbols. The Make system aggregates these into `r2plugins.h`.

```c
// core/deps.h
#ifdef R2_CORE_H
extern RCorePlugin r_core_plugin_your_plugin;
#endif
```

```c
// asm/deps.h
#ifdef R_ASM_H
extern RAsmPlugin r_asm_plugin_your_plugin;
#endif
```

#### `<type>/deps.mk`

Makefile that defines:
- Compiler flags needed for your plugin
- Where to find your static libraries
- Object files to link
- Dependencies

Example:

```makefile
# core/deps.mk
YOUR_PLUGIN_WD=$(LIBR)/xps/p/your_plugin
CFLAGS+=-I$(YOUR_PLUGIN_WD)/include
YOUR_PLUGIN_OBJ=$(YOUR_PLUGIN_WD)/src/your_plugin.o
YOUR_PLUGIN_LIB=$(YOUR_PLUGIN_WD)/build/libyourplugin.a
LDFLAGS+=$(YOUR_PLUGIN_LIB)
EXTERNAL_STATIC_OBJS+=$(YOUR_PLUGIN_OBJ)
```

**Key Variables**:
- `$(LIBR)` - Path to libr/ directory (defined in config.mk)
- `CFLAGS+=` - Add compiler flags
- `LDFLAGS+=` - Add linker flags
- `EXTERNAL_STATIC_OBJS+=` - Add object files to link into core

#### `<type>/meson.build`

Optional Meson configuration for type-specific build logic. For most cases, the parent r2plugin/meson.build is sufficient.

If needed, create this to add type-specific sources:

```meson
# asm/meson.build
asm_plugin_sources = files(
  '../src/asm_plugin.c',
)
r_core_additional_sources += asm_plugin_sources
```

### Step 4: Enable the Plugin

Edit `libr/xps/config.mk` and add your plugin:

```makefile
EXTERNAL_PLUGINS+=your_plugin
```

This tells the Make system to include your plugin in the build.

### Step 5: Generate Integration Files

Run the Make generator to create the aggregated files:

```bash
make -C libr/xps
```

This generates:
- `p/meson.build` - Lists all plugins' r2plugin/ subdirectories
- `static.cfg` - Aggregated list of all plugin types
- `deps.mk` - Includes all plugin deps.mk files
- `r2plugins.h` - Includes all plugin deps.h files

### Step 6: Build radare2

Now build radare2 with your plugin integrated:

```bash
# Make way
./configure
make -j
sudo make install

# Meson way
meson setup builddir
meson compile -C builddir
sudo meson install -C builddir
```

### Complete Example

For a plugin named `myplugin` providing a core plugin type:

```
libr/xps/p/myplugin/
├── r2plugin/
│   ├── static.cfg                    # Define: core.myplugin
│   ├── meson.build                   # Append sources to r_core_additional_*
│   └── core/
│       ├── deps.h                    # Declare: extern RCorePlugin r_core_plugin_myplugin
│       └── deps.mk                   # Define: paths, flags, EXTERNAL_STATIC_OBJS
└── src/
    ├── plugin.c
    ├── plugin.h
    └── ... other files ...
```

And in `libr/xps/config.mk`:

```makefile
EXTERNAL_PLUGINS+=myplugin
```

Then run:

```bash
make -C libr/xps
./configure && make -j
```

## Troubleshooting

### Make Build Issues

- **"Missing dependency"**: Ensure plugin dependencies are listed in `deps.mk`
- **"Undefined reference"**: Check `deps.h` for missing extern declarations
- **"File not found"**: Verify paths in `deps.mk` are relative to `$(LIBR)/xps/`

### Meson Build Issues

- **"r_core_additional_sources/inc not found"**: Ensure `subdir('xps')` comes before core plugin includes
- **"Missing includes"**: Add paths to `r_core_additional_inc` before using sources
- **"Link errors"**: Verify external libraries are in `r_core_additional_sources`

### Plugin Not Loading

1. Check plugin registration: `r2 -c 'Lc~<plugin_type>'`
2. Verify plugin file exists in plugin directory
3. Check r2 plugin path: `r2 -c 'e asm.plugins'` (or other plugin type)

## References

- Plugin definition: `libr/include/r_plugins.h`
- Core plugin interface: `libr/core/cplugin.c`
- Example plugin (r2hermes): https://github.com/radareorg/r2hermes
- radare2 Plugins documentation: https://radare.org/

